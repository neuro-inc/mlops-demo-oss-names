kind: live
title: MLOps Demo - OSS - Names

defaults:
  preset: cpu-small
  life_span: 1d

volumes:
  code:
    remote: storage:$[[ flow.project_id ]]/rnn
    mount: /project/rnn
    local: rnn
  config:
    remote: storage:$[[ flow.project_id ]]/config
    mount: /project/config
    local: config
  notebooks:
    remote: storage:$[[ flow.project_id ]]/notebooks
    mount: /project/notebooks
    local: notebooks
  results:
    remote: storage:$[[ flow.project_id ]]/results
    mount: /project/results
    local: results
  project:
    remote: storage:$[[ flow.project_id ]]
    mount: /project
    local: .

images:
  myimage:
    ref: image:$[[ flow.project_id ]]:v3
    dockerfile: $[[ flow.workspace ]]/Dockerfile
    context: $[[ flow.workspace ]]/
    build_preset: cpu-small

jobs:

  train:
    image: $[[ images.myimage.ref ]]
    pass_config: true
    multi: true
    volumes:
      - $[[ upload(volumes.code).ref_ro ]]
      - $[[ upload(volumes.config).ref_ro ]]
      - $[[ volumes.results.ref_rw ]]
    workdir: $[[ volumes.project.mount ]]
    env:
      EXPOSE_SSH: "yes"
      PYTHONPATH: $[[ volumes.code.mount ]]
    params:
      train_iterations: "10000"
    bash: |
        tmpdir=`mktemp -d`
        neuro blob cp -r blob:names-project/data $tmpdir
        python -u $[[ volumes.code.mount ]]/char_rnn_classification_tutorial.py \
          --dump_dir $[[ volumes.results.mount ]] --data_path $tmpdir/data --n_iters $[[ params.train_iterations ]]

  jupyter:
    image: $[[ images.myimage.ref ]]
    browse: true
    http_port: 8080
    pass_config: True
    multi: true
    volumes:
      - $[[ upload(volumes.code).ref_rw ]]
      - $[[ upload(volumes.config).ref_rw ]]
      - $[[ upload(volumes.notebooks).ref_rw ]]
      - $[[ volumes.results.ref_rw ]]
    workdir: /project
    env:
      PYTHONPATH: $[[ volumes.code.mount ]]
    bash: |
      neuro blob cp -r blob:names-project/data /project/data
      jupyter lab \
        --no-browser \
        --ip=0.0.0.0 \
        --port=8080 \
        --allow-root \
        --NotebookApp.token= \
        --NotebookApp.shutdown_no_activity_timeout=7200 \
        --MappingKernelManager.cull_idle_timeout=7200 \
        --notebook-dir=$[[ volumes.notebooks.mount ]]

  tensorboard:
    action: gh:neuro-actions/tensorboard@v1.0.0
    args:
      volumes_results_remote: $[[ volumes.results.remote ]]

  filebrowser:
    action: gh:neuro-actions/filebrowser@v1.0.0
    args:
      volumes_project_remote: $[[ volumes.project.remote ]]
